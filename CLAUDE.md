# NOAH 项目 Claude Code 开发规范

> NOAH Opens Android on Harmony - AI 驱动的 API 适配层生成系统

## 项目概述

NOAH 使用 AI 自动化生成 Android API 到 HarmonyOS API 的转接层。Claude Code 在本项目中承担核心代码生成职责。

## 技术栈

- **语言**: Python 3.11+
- **AI 引擎**: Claude API (Opus 4.5)
- **解析器**: Tree-sitter / JavaParser
- **模板**: Jinja2
- **存储**: SQLite + YAML
- **任务调度**: Celery + Redis

## 开发规范

### 1. API 规格文件规范

API 规格使用 YAML 格式，存放在 `specs/` 目录：

```yaml
# specs/android/android.app.Activity.yaml
api_spec:
  platform: android
  package: android.app
  class: Activity
  methods:
    - name: methodName
      signature: "returnType methodName(params)"
      semantic_tags: [tag1, tag2]
```

### 2. 映射规则规范

映射规则存放在 `configs/mapping_rules.yaml`：

```yaml
mappings:
  - android: android.app.Activity
    harmony: ohos.app.UIAbility
    type: direct  # direct | semantic | bridge
    confidence: 0.95
```

### 3. 代码生成规范

生成的适配器代码必须包含：

```java
/**
 * Auto-generated by NOAH v{version}
 * Source: {android_class}
 * Target: {harmony_class}
 * Confidence: {confidence}
 * Generated: {timestamp}
 *
 * DO NOT EDIT MANUALLY - regenerate using NOAH pipeline
 */
```

### 4. 测试规范

每个生成的适配器必须有对应测试：

- 单元测试: `tests/unit/test_{adapter_name}.py`
- 集成测试: `tests/integration/test_{adapter_name}_integration.py`

### 5. 提交规范

```bash
# 适配器生成
feat(adapter): add Activity adapter for ohos.app.UIAbility

# 映射规则更新
feat(mapping): add semantic mapping for Toast API

# 流水线改进
fix(pipeline): improve batch processing stability

# 文档更新
docs: update API mapping specification
```

## 目录结构

```
NOAH/
├── src/
│   ├── core/           # 核心数据结构
│   ├── analyzers/      # SDK 解析器
│   ├── generators/     # 代码生成器
│   ├── testing/        # 测试框架
│   └── pipeline/       # 自动化流水线
├── specs/              # API 规格
├── templates/          # 代码模板
├── configs/            # 配置文件
└── output/             # 生成产物
```

## AI 使用策略

根据任务复杂度选择合适的 AI 策略：

| 复杂度 | 策略 | 模型 |
|--------|------|------|
| 低 | 规则匹配 | 无 |
| 中低 | 轻量验证 | Haiku |
| 中 | 标准生成 | Sonnet |
| 高 | 高级生成 | Opus |

## 质量门禁

代码合并前必须通过：

- [ ] 单元测试通过率 > 95%
- [ ] 代码覆盖率 > 80%
- [ ] 无 Critical/High 级别问题
- [ ] 文档同步更新

## 常用命令

```bash
# 解析 SDK
python -m noah.analyzers.android_parser --sdk-path /path/to/sdk

# 生成适配器
python -m noah.generators.adapter_generator --package android.app

# 运行测试
pytest src/testing/ -v

# 运行流水线
python -m noah.pipeline.orchestrator --mode incremental
```

## 注意事项

1. **不要手动修改** `output/` 目录下的生成文件
2. **优先更新映射规则**，而不是直接修改生成逻辑
3. **保持 API 规格的准确性**，这是所有生成的基础
4. **测试先行**：新增映射规则前先编写测试用例
